<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinese Character Detective</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(rgba(26, 26, 46, 0.85), rgba(22, 33, 62, 0.9)), 
                        url('https://images.unsplash.com/photo-1550684376-efcbd6e3f031?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #e6e6e6;
            overflow-x: hidden;
        }
        
        .container {
            width: 100%;
            max-width: 1000px;
            background: rgba(30, 30, 46, 0.9);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            padding: 30px;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
            border: 1px solid #39395a;
            backdrop-filter: blur(5px);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }
        
        h1 {
            color: #e6e6e6;
            margin-bottom: 10px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            color: #a0a0c0;
            font-size: 1.2rem;
        }
        
        .home-screen, .chapter-screen {
            width: 100%;
        }
        
        .chapters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .chapter-card {
            background: rgba(40, 40, 60, 0.7);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: 1px solid #4a4a6a;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .chapter-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            border-color: #6366f1;
        }
        
        .chapter-card.completed::before {
            content: "✓";
            position: absolute;
            top: 10px;
            right: 10px;
            background: #10b981;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .chapter-card.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .chapter-card.locked::after {
            content: "🔒";
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
        }
        
        .chapter-title {
            font-size: 1.4rem;
            color: #f8fafc;
            margin-bottom: 10px;
        }
        
        .chapter-description {
            color: #a0a0c0;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .progress-container {
            margin: 30px 0;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #a0a0c0;
        }
        
        .progress-bar {
            height: 12px;
            background: rgba(40, 40, 60, 0.8);
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #4a4a6a;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            width: 0%;
            transition: width 0.5s;
            border-radius: 6px;
        }
        
        .game-area {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            position: relative;
            z-index: 1;
        }
        
        .story-panel {
            flex: 1;
            min-width: 300px;
            background: rgba(40, 40, 60, 0.7);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: 1px solid #4a4a6a;
        }
        
        .game-panel {
            flex: 2;
            min-width: 400px;
            background: rgba(40, 40, 60, 0.7);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: 1px solid #4a4a6a;
        }
        
        .character-display {
            font-size: 140px;
            text-align: center;
            margin: 20px 0;
            color: #f8fafc;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(30, 30, 46, 0.8);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: 1px solid #4a4a6a;
            text-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
        }
        
        .character-info {
            background: rgba(50, 50, 70, 0.8);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #10b981;
        }
        
        .pinyin {
            font-size: 1.8rem;
            color: #f59e0b;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .meaning {
            font-size: 1.2rem;
            color: #e6e6e6;
            margin-bottom: 10px;
        }
        
        .example {
            font-size: 1rem;
            color: #a0a0c0;
            font-style: italic;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #4a4a6a;
        }
        
        .input-area {
            margin-top: 20px;
        }
        
        input {
            width: 100%;
            padding: 14px 15px;
            border: 2px solid #4a4a6a;
            border-radius: 8px;
            font-size: 1.1rem;
            margin-bottom: 15px;
            transition: border-color 0.3s;
            background: rgba(30, 30, 46, 0.8);
            color: #e6e6e6;
        }
        
        input:focus {
            border-color: #6366f1;
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        input::placeholder {
            color: #8a8aa8;
        }
        
        button {
            background: linear-gradient(90deg, #0ea5e9, #6366f1);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        button:hover {
            background: linear-gradient(90deg, #0284c7, #4f46e5);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-secondary {
            background: linear-gradient(90deg, #10b981, #059669);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(90deg, #059669, #047857);
        }
        
        .btn-home {
            background: linear-gradient(90deg, #8b5cf6, #a855f7);
            margin-top: 20px;
        }
        
        .hint {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid #f59e0b;
            padding: 12px 15px;
            margin: 15px 0;
            border-radius: 0 5px 5px 0;
            font-size: 0.95rem;
            color: #fcd34d;
        }
        
        .success {
            color: #10b981;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
            padding: 12px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 5px;
            border: 1px solid #10b981;
        }
        
        .error {
            color: #ef4444;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
            padding: 12px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 5px;
            border: 1px solid #ef4444;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            font-size: 0.9rem;
            color: #a0a0c0;
        }
        
        .npc-image {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #0ea5e9);
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .story-controls {
            display: flex;
            gap: 10px;
        }
        
        .story-controls button {
            flex: 1;
        }
        
        .interview-question {
            font-size: 1.3rem;
            color: #f8fafc;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(60, 60, 80, 0.8);
            border-radius: 8px;
            border-left: 4px solid #0ea5e9;
        }
        
        .interview-context {
            font-size: 1rem;
            color: #a0a0c0;
            margin-bottom: 20px;
            font-style: italic;
        }
        
        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(16, 185, 129, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        
        .celebration.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .celebration h2 {
            font-size: 3rem;
            color: white;
            margin-bottom: 20px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .celebration p {
            font-size: 1.5rem;
            color: white;
            text-align: center;
            max-width: 600px;
            margin-bottom: 30px;
        }
        
        .chapter-complete {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(16, 185, 129, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        
        .chapter-complete.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .chapter-complete h2 {
            font-size: 4rem;
            color: white;
            margin-bottom: 20px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            animation: pulse 2s infinite;
        }
        
        .chapter-complete p {
            font-size: 1.8rem;
            color: white;
            text-align: center;
            max-width: 600px;
            margin-bottom: 30px;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .firework {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            box-shadow: 0 0 10px #fff;
            animation: firework-animation 1.5s ease-out forwards;
        }
        
        @keyframes firework-animation {
            0% {
                transform: translate(var(--x), var(--y));
                width: 5px;
                height: 5px;
                opacity: 1;
            }
            50% {
                width: 3px;
                height: 3px;
                opacity: 1;
            }
            100% {
                width: 200px;
                height: 200px;
                opacity: 0;
            }
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .game-area {
                flex-direction: column;
            }
            
            .chapters-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Home Screen -->
        <div class="home-screen" id="home-screen">
            <header>
                <h1>Chinese Character Detective</h1>
                <p class="subtitle">Learn Chinese characters through interactive detective stories</p>
            </header>
            
            <div class="progress-container">
                <div class="progress-label">
                    <span>Overall Progress</span>
                    <span id="overall-progress">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress" id="overall-progress-bar"></div>
                </div>
            </div>
            
            <h2 style="margin: 30px 0 20px; text-align: center;">Choose a Chapter</h2>
            
            <div class="chapters-grid" id="chapters-grid">
                <!-- Chapters will be dynamically generated -->
            </div>
        </div>
        
        <!-- Chapter Screen -->
        <div class="chapter-screen hidden" id="chapter-screen">
            <div class="chapter-title" id="chapter-title">Chapter 1: The Detective Agency Interview</div>
            
            <div class="game-area">
                <div class="story-panel">
                    <div class="npc-image" id="npc-image">社</div>
                    <div class="story-content" id="story-content">
                        <p>Welcome to the Chinese Character Detective Agency! I'm Director Li Ming.</p>
                        <p>We're looking for new detectives who can solve mysteries using Chinese characters. To join our team, you need to pass this interview.</p>
                        <p>I'll ask you some questions in Chinese. Try to understand and respond appropriately.</p>
                        <p><strong>Mission:</strong> Answer all interview questions correctly.</p>
                    </div>
                    
                    <div class="progress-container">
                        <div>Chapter Progress</div>
                        <div class="progress-bar">
                            <div class="progress" id="story-progress"></div>
                        </div>
                        <div class="stats">
                            <div>Chapter: <span id="chapter-num">1</span>/5</div>
                            <div>Question: <span id="task-progress">1</span>/<span id="total-tasks">2</span></div>
                        </div>
                    </div>
                    
                    <div class="story-controls">
                        <button id="prev-btn">Previous Question</button>
                        <button id="next-btn" class="btn-secondary">Next Question</button>
                    </div>
                    
                    <button id="back-to-home" class="btn-home">Back to Home</button>
                </div>
                
                <div class="game-panel">
                    <div class="interview-context" id="interview-context">
                        Director Li Ming looks at you and says:
                    </div>
                    
                    <div class="interview-question" id="current-question">你好</div>
                    
                    <div class="character-display" id="current-character">你</div>
                    
                    <div class="character-info">
                        <div class="pinyin" id="pinyin">nǐ hǎo</div>
                        <div class="meaning" id="meaning">Hello - A common Chinese greeting</div>
                        <div class="example" id="example">Response: 你好！(Nǐ hǎo! - Hello!)</div>
                    </div>
                    
                    <div class="hint" id="hint">
                        <strong>Detective Tip:</strong> This is a standard Chinese greeting. The director is saying "Hello" to you.
                    </div>
                    
                    <div class="input-area">
                        <input type="text" id="answer-input" placeholder="How would you respond to this greeting?">
                        <button id="submit-btn">Submit Answer</button>
                        <div id="result-message"></div>
                    </div>
                    
                    <div class="progress-container">
                        <div>Learning Progress</div>
                        <div class="progress-bar">
                            <div class="progress" id="learning-progress"></div>
                        </div>
                        <div class="stats">
                            <div>Learned: <span id="learned-count">1</span>/30</div>
                            <div>Accuracy: <span id="accuracy">100%</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="celebration" id="celebration">
        <h2>Correct!</h2>
        <p>Well done! You've answered correctly.</p>
    </div>
    
    <div class="chapter-complete" id="chapter-complete">
        <h2>Congratulations!</h2>
        <p>You've successfully completed this chapter!</p>
        <p>Returning to the home screen...</p>
    </div>

    <script>
        // Game data
        const gameData = {
            completedChapters: [],
            currentChapter: null,
            progress: 0
        };

        // Chapters data
        const chapters = [
            {
                id: 1,
                title: "The Detective Agency Interview",
                description: "Join the detective agency by passing an interview in Chinese. Answer questions about yourself to prove your skills.",
                npc: "社",
                questions: [
                    {
                        question: "你好",
                        pinyin: "nǐ hǎo",
                        meaning: "Hello - A common Chinese greeting",
                        example: "Response: 你好！(Nǐ hǎo! - Hello!)",
                        hint: "This is a standard Chinese greeting. The director is saying 'Hello' to you.",
                        correctAnswers: ["你好", "nǐ hǎo", "hello", "hi"],
                        context: "Director Li Ming looks at you and says:"
                    },
                    {
                        question: "你叫什么名字？",
                        pinyin: "nǐ jiào shénme míngzì?",
                        meaning: "What is your name? - Asking for someone's name",
                        example: "Response: 我叫... (Wǒ jiào... - My name is...)",
                        hint: "The director is asking for your name. In Chinese, people often respond with '我叫' followed by their name.",
                        correctAnswers: ["我叫", "wǒ jiào", "my name is"],
                        context: "The director smiles and asks:"
                    }
                ],
                story: "Welcome to the Chinese Character Detective Agency! I'm Director Li Ming. We're looking for new detectives who can solve mysteries using Chinese characters. To join our team, you need to pass this interview. I'll ask you some questions in Chinese. Try to understand and respond appropriately."
            },
            {
                id: 2,
                title: "The Mystery Gift",
                description: "Help a friend decipher a mysterious gift message written in Chinese characters.",
                npc: "礼",
                questions: [
                    {
                        question: "这是给你的礼物",
                        pinyin: "zhè shì gěi nǐ de lǐwù",
                        meaning: "This is a gift for you",
                        example: "Response: 谢谢！(Xièxie! - Thank you!)",
                        hint: "This sentence tells you that something is a gift for you.",
                        correctAnswers: ["谢谢", "xièxie", "thank you"],
                        context: "Your friend hands you a gift and says:"
                    },
                    {
                        question: "你喜欢吗？",
                        pinyin: "nǐ xǐhuān ma?",
                        meaning: "Do you like it? - Asking if someone likes something",
                        example: "Response: 喜欢！(Xǐhuān! - I like it!)",
                        hint: "Your friend is asking if you like the gift.",
                        correctAnswers: ["喜欢", "xǐhuān", "i like it", "yes"],
                        context: "Your friend asks:"
                    }
                ],
                story: "Your friend has received a mysterious gift with a note written in Chinese. They need your help to understand the message and respond appropriately. Use your detective skills to decipher the characters!"
            },
            {
                id: 3,
                title: "The Time Puzzle",
                description: "Solve a time-related mystery by understanding Chinese time expressions.",
                npc: "时",
                questions: [
                    {
                        question: "现在几点？",
                        pinyin: "xiànzài jǐ diǎn?",
                        meaning: "What time is it now? - Asking for the current time",
                        example: "Response: 现在三点。(Xiànzài sān diǎn. - It's three o'clock now.)",
                        hint: "This question is asking for the current time.",
                        correctAnswers: ["现在", "xiànzài", "it is", "it's"],
                        context: "Someone asks you:"
                    },
                    {
                        question: "你几点起床？",
                        pinyin: "nǐ jǐ diǎn qǐchuáng?",
                        meaning: "What time do you get up? - Asking about waking up time",
                        example: "Response: 我七点起床。(Wǒ qī diǎn qǐchuáng. - I get up at seven.)",
                        hint: "This question is about your waking up schedule.",
                        correctAnswers: ["我", "wǒ", "i get up at", "at"],
                        context: "A curious friend asks:"
                    }
                ],
                story: "There's been a mix-up with the train schedule, and you need to help sort it out. Understanding Chinese time expressions is crucial to solving this puzzle and making sure everyone catches their trains on time."
            },
            {
                id: 4,
                title: "A Family Photo Album",
                description: "Help identify family members in an old photo album using Chinese kinship terms.",
                npc: "家",
                questions: [
                    {
                        question: "这是谁？",
                        pinyin: "zhè shì shéi?",
                        meaning: "Who is this? - Asking to identify someone",
                        example: "Response: 这是我爸爸。(Zhè shì wǒ bàba. - This is my father.)",
                        hint: "This question is asking you to identify a person.",
                        correctAnswers: ["这是我", "zhè shì wǒ", "this is my"],
                        context: "Pointing at a photo, someone asks:"
                    },
                    {
                        question: "你有哥哥吗？",
                        pinyin: "nǐ yǒu gēgē ma?",
                        meaning: "Do you have an older brother? - Asking about siblings",
                        example: "Response: 有，我有一个哥哥。(Yǒu, wǒ yǒu yī gè gēgē. - Yes, I have one older brother.)",
                        hint: "This question is about whether you have an older brother.",
                        correctAnswers: ["有", "yǒu", "yes i have", "i have"],
                        context: "Looking at a family photo, someone asks:"
                    }
                ],
                story: "An elderly neighbor needs help identifying people in their family photo album. The labels have faded, and only the Chinese characters remain. Use your knowledge of family terms to help them reconnect with their memories."
            },
            {
                id: 5,
                title: "The Ultimate Challenge",
                description: "Put all your skills to the test in this final challenge combining everything you've learned.",
                npc: "侦",
                questions: [
                    {
                        question: "你会说汉语吗？",
                        pinyin: "nǐ huì shuō Hànyǔ ma?",
                        meaning: "Can you speak Chinese? - Asking about language ability",
                        example: "Response: 我会说一点汉语。(Wǒ huì shuō yīdiǎn Hànyǔ. - I can speak a little Chinese.)",
                        hint: "This question is about your Chinese language ability.",
                        correctAnswers: ["我会说", "wǒ huì shuō", "i can speak"],
                        context: "The final test begins with this question:"
                    },
                    {
                        question: "你喜欢学习汉语吗？",
                        pinyin: "nǐ xǐhuān xuéxí Hànyǔ ma?",
                        meaning: "Do you like learning Chinese? - Asking about language learning preference",
                        example: "Response: 喜欢，汉语很有意思！(Xǐhuān, Hànyǔ hěn yǒuyìsi! - Yes, Chinese is very interesting!)",
                        hint: "This question is about your enjoyment of learning Chinese.",
                        correctAnswers: ["喜欢", "xǐhuān", "yes i like", "i like"],
                        context: "The examiner continues:"
                    }
                ],
                story: "This is it - the final test of your Chinese detective skills! You'll need to use everything you've learned to solve this ultimate challenge. Show them what you're made of!"
            }
        ];

        // Game state for current chapter
        let currentTask = 0;
        let learnedCharacters = [];
        let correctAnswers = 0;
        let totalAttempts = 0;

        // DOM elements
        const homeScreen = document.getElementById('home-screen');
        const chapterScreen = document.getElementById('chapter-screen');
        const chaptersGrid = document.getElementById('chapters-grid');
        const overallProgress = document.getElementById('overall-progress');
        const overallProgressBar = document.getElementById('overall-progress-bar');
        const chapterTitle = document.getElementById('chapter-title');
        const npcImage = document.getElementById('npc-image');
        const storyContent = document.getElementById('story-content');
        const interviewContext = document.getElementById('interview-context');
        const currentQuestion = document.getElementById('current-question');
        const currentCharacter = document.getElementById('current-character');
        const pinyinEl = document.getElementById('pinyin');
        const meaningEl = document.getElementById('meaning');
        const exampleEl = document.getElementById('example');
        const hintEl = document.getElementById('hint');
        const answerInput = document.getElementById('answer-input');
        const submitBtn = document.getElementById('submit-btn');
        const resultMessage = document.getElementById('result-message');
        const storyProgress = document.getElementById('story-progress');
        const learningProgress = document.getElementById('learning-progress');
        const chapterNum = document.getElementById('chapter-num');
        const taskProgress = document.getElementById('task-progress');
        const totalTasks = document.getElementById('total-tasks');
        const learnedCount = document.getElementById('learned-count');
        const accuracyEl = document.getElementById('accuracy');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const backToHome = document.getElementById('back-to-home');
        const celebration = document.getElementById('celebration');
        const chapterComplete = document.getElementById('chapter-complete');

        // Initialize game
        function initGame() {
            // Load saved progress
            const savedProgress = localStorage.getItem('chineseDetectiveProgress');
            if (savedProgress) {
                Object.assign(gameData, JSON.parse(savedProgress));
            }
            
            renderHomeScreen();
            setupEventListeners();
        }

        // Render home screen with chapters
        function renderHomeScreen() {
            chaptersGrid.innerHTML = '';
            
            chapters.forEach(chapter => {
                const isCompleted = gameData.completedChapters.includes(chapter.id);
                const isLocked = false; // Remove locking for demo - all chapters accessible
                
                const chapterCard = document.createElement('div');
                chapterCard.className = `chapter-card ${isCompleted ? 'completed' : ''} ${isLocked ? 'locked' : ''}`;
                chapterCard.innerHTML = `
                    <div class="chapter-title">Chapter ${chapter.id}: ${chapter.title}</div>
                    <div class="chapter-description">${chapter.description}</div>
                `;
                
                if (!isLocked) {
                    chapterCard.addEventListener('click', () => startChapter(chapter.id));
                }
                
                chaptersGrid.appendChild(chapterCard);
            });
            
            // Update overall progress
            const progress = (gameData.completedChapters.length / chapters.length) * 100;
            overallProgress.textContent = `${Math.round(progress)}%`;
            overallProgressBar.style.width = `${progress}%`;
        }

        // Start a chapter
        function startChapter(chapterId) {
            gameData.currentChapter = chapterId;
            currentTask = 0;
            learnedCharacters = [];
            correctAnswers = 0;
            totalAttempts = 0;
            
            const chapter = chapters.find(c => c.id === chapterId);
            if (!chapter) return;
            
            // Update UI for chapter
            chapterTitle.textContent = `Chapter ${chapter.id}: ${chapter.title}`;
            npcImage.textContent = chapter.npc;
            storyContent.innerHTML = `<p>${chapter.story}</p><p><strong>Mission:</strong> Answer all ${chapter.questions.length} questions correctly.</p>`;
            chapterNum.textContent = chapter.id;
            totalTasks.textContent = chapter.questions.length;
            
            // Show chapter screen
            homeScreen.classList.add('hidden');
            chapterScreen.classList.remove('hidden');
            
            // Display first task
            displayTask();
        }

        // Display current task
        function displayTask() {
            const chapter = chapters.find(c => c.id === gameData.currentChapter);
            if (!chapter || currentTask >= chapter.questions.length) return;
            
            const question = chapter.questions[currentTask];
            
            // Update question and context
            currentQuestion.textContent = question.question;
            interviewContext.textContent = question.context;
            
            // Update character display (show first character of the question)
            currentCharacter.textContent = question.question.charAt(0);
            
            // Update character info
            pinyinEl.textContent = question.pinyin;
            meaningEl.textContent = question.meaning;
            exampleEl.textContent = question.example;
            
            // Update hint
            hintEl.innerHTML = `<strong>Detective Tip:</strong> ${question.hint}`;
            
            // Update task progress
            taskProgress.textContent = currentTask + 1;
            
            // Clear input and result
            answerInput.value = '';
            resultMessage.textContent = '';
            resultMessage.className = '';
            
            // Focus on input
            answerInput.focus();
            
            updateProgress();
        }

        // Check answer
        function checkAnswer() {
            const chapter = chapters.find(c => c.id === gameData.currentChapter);
            if (!chapter) return;
            
            const question = chapter.questions[currentTask];
            const userAnswer = answerInput.value.trim().toLowerCase();
            
            // Check if answer is correct
            let isCorrect = false;
            for (let correctAnswer of question.correctAnswers) {
                if (userAnswer.includes(correctAnswer.toLowerCase())) {
                    isCorrect = true;
                    break;
                }
            }
            
            totalAttempts++;
            if (isCorrect) {
                correctAnswers++;
                resultMessage.textContent = 'Correct! Excellent work, Detective!';
                resultMessage.className = 'success';
                
                // Show celebration
                showCelebration();
                
                // Automatically move to next question after 2 seconds
                setTimeout(nextTask, 2000);
            } else {
                resultMessage.textContent = 'Try again. Remember the response pattern from the example.';
                resultMessage.className = 'error';
            }
            
            updateProgress();
        }

        // Show celebration
        function showCelebration() {
            celebration.classList.add('active');
            
            // Hide celebration after 2 seconds
            setTimeout(() => {
                celebration.classList.remove('active');
            }, 2000);
        }

        // Next task
        function nextTask() {
            const chapter = chapters.find(c => c.id === gameData.currentChapter);
            if (!chapter) return;
            
            if (currentTask < chapter.questions.length - 1) {
                currentTask++;
                displayTask();
            } else {
                // All questions completed - show chapter complete celebration
                showChapterComplete();
            }
            
            updateProgress();
        }

        // Previous task
        function prevTask() {
            if (currentTask > 0) {
                currentTask--;
                displayTask();
            }
            
            updateProgress();
        }

        // Show chapter complete celebration
        function showChapterComplete() {
            chapterComplete.classList.add('active');
            
            // Mark chapter as completed
            if (!gameData.completedChapters.includes(gameData.currentChapter)) {
                gameData.completedChapters.push(gameData.currentChapter);
                saveProgress();
            }
            
            // Create fireworks effect
            createFireworks();
            
            // Return to home screen after 2 seconds
            setTimeout(() => {
                chapterComplete.classList.remove('active');
                returnToHome();
            }, 2000);
        }

        // Create fireworks effect
        function createFireworks() {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
            const container = chapterComplete;
            
            for (let i = 0; i < 30; i++) {
                const firework = document.createElement('div');
                firework.className = 'firework';
                firework.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                firework.style.left = Math.random() * 100 + 'vw';
                firework.style.top = Math.random() * 100 + 'vh';
                firework.style.setProperty('--x', (Math.random() * 40 - 20) + 'px
